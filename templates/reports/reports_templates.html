<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üìä Template Creator</title>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  body { font-family: sans-serif; background:#f4f6f9; padding:20px; }
  h2 { margin-bottom:10px; }
  .swal2-html-container select, .swal2-html-container input {
    width:100%; margin:5px 0; padding:6px; border-radius:4px;
    border:1px solid #ccc; font-size:14px;
  }
  button.add-btn {
    margin-top:6px; background:#007bff; color:#fff;
    border:none; padding:6px 10px; border-radius:4px; cursor:pointer;
  }
  button.add-btn:hover { background:#0056b3; }
</style>
</head>
<body>
<h2>üìä Report Template Builder</h2>
<button onclick="openTemplateWizard()">‚ûï Create Template</button>
<div id="templateList" style="margin-top:20px;"></div>

<script>
const LEVEL_OPTIONS = [
  { label: "Delivery Date", field: "deldate" },
  { label: "DelNoteNo", field: "delnoteno" },
  { label: "Agent", field: "agentname" },
  { label: "Packhouse", field: "packhousename" },
  { label: "Production Unit", field: "produnitname" },
  { label: "Main Production Unit", field: "mainprodunitname" },
  { label: "Transporter", field: "transportername" },
  { label: "Product", field: "productdescription" }
];

// Field options with sum/average info
const FIELD_OPTIONS = [
    { label: "Delivery Date", field: "deldate", totalType: "none" },
    { label: "DelNoteNo", field: "delnoteno", totalType: "none" },
    { label: "Transport Cost Exc", field: "deltransportcostexcl", totalType: "sum" },
    { label: "Agent", field: "agentname", totalType: "none" },
    { label: "Production Unit", field: "produnitname", totalType: "none" },
    { label: "Main Production Unit", field: "mainprodunitname", totalType: "none" },
    { label: "Transporter", field: "transportername", totalType: "none" },
    { label: "Transporter Type", field: "transporttype", totalType: "none" },
    { label: "Estimated Gross", field: "estimatedgross", totalType: "sum" },
    { label: "Estimated Nett", field: "dellineestimatednett", totalType: "sum" },
    { label: "Total Qty Delivered", field: "dellinequantitybags", totalType: "sum" },
    { label: "Total Qty Sold", field: "totalqtysold", totalType: "sum" },
    { label: "Sold Gross", field: "salesgrossamnt", totalType: "sum" },
    { label: "Sold Nett", field: "salesnettamnt", totalType: "sum" },
    { label: "Qty Not Sold", field: "availableqtyforsale", totalType: "sum" },
    { label: "Total Qty Invoiced", field: "totalqtyinvoiced", totalType: "sum" },
    { label: "Invoiced Gross", field: "invoicedgrossamnt", totalType: "sum" },
    { label: "Invoiced Nett", field: "invoicednettamnt", totalType: "sum" },
    { label: "Destroyed Qty", field: "destroyedqty", totalType: "sum" },
    { label: "Destroyed Gross", field: "destroyedgrosssalesamnt", totalType: "sum" },
    { label: "Destroyed Nett", field: "destroyednettsalesamnt", totalType: "sum" },
    { label: "Weight Delivered", field: "weightkgdelivered", totalType: "sum" },
    { label: "Weight Sold", field: "weightkgsold", totalType: "sum" },
    { label: "Weight Invoiced", field: "weightkginvoiced", totalType: "sum" },
    { label: "Delivered Transport Cost", field: "deliveredtransportcost", totalType: "sum" },
    { label: "Delivered Packaging Cost", field: "deliveredpackagingcost", totalType: "sum" },
    { label: "Average Gross Sold", field: "salesgrossamnt / totalqtysold", totalType: "avg", weightField: "totalqtysold" },
    { label: "Average Nett Sold", field: "salesnettamnt / totalqtysold", totalType: "avg", weightField: "totalqtysold" },
    { label: "Gross Sold Price/10kg", field: "salesgrossamnt / weightkgsold * 10", totalType: "avg", weightField: "weightkgsold" },
    { label: "Nett Sold Price/10kg", field: "salesnettamnt / weightkgsold * 10", totalType: "avg", weightField: "weightkgsold * 10" },
    { label : "Sold After Transport", fied:"salesnettamnt - soldtransportcost", totalType:"sum"},
    { label : "Sold After Transport/10kg", fied:"(salesnettamnt - soldtransportcost) / weightkgsold * 10", totalType:"sum"},
    { label : "Invoiced After Transport", fied:"invoicednettamnt - invoicedtransportcost", totalType:"sum"},
    { label: "Delivered/10kg", field: "weightkgdelivered / 10", totalType: "sum" },
    { label: "Sold/10kg", field: "weightkgsold / 10", totalType: "sum"},
    { label: "Not Sold/10kg", field: "(weightkgdelivered - weightkgsold) / 10", totalType: "sum"},
    { label: "Sold Transport", field: "soldtransportcost", totalType: "sum"},
    { label: "DeliveredTotalCost", field: "deliveredtransportcost + deliveredpackagingcost", totalType: "sum"},
];

// Step 1: Template Name
async function openTemplateWizard(){
  const { value: name } = await Swal.fire({
    title:"Template Name",
    input:"text",
    inputLabel:"Enter template name:",
    inputPlaceholder:"e.g. Weekly Delivery Summary",
    confirmButtonText:"Next ‚Üí"
  });
  if(!name) return;

  // Step 2: Levels
  let levelHTML = `<div id='level-container'>
    <div class='level-row'>
      <select class='level-select'>
        <option value="">-- Select Level --</option>
        ${LEVEL_OPTIONS.map(l => `<option value='${l.field}'>${l.label}</option>`).join("")}
      </select>
    </div>
  </div>
  <button type='button' class='add-btn' onclick='addLevelRow()'>‚ûï Add Level</button>`;

  await Swal.fire({
    title:"Choose Levels",
    html:levelHTML,
    showCancelButton:true,
    confirmButtonText:"Next ‚Üí",
    didOpen:() => { window.levelContainer = document.getElementById("level-container"); },
    preConfirm:() => {
      const levels = Array.from(document.querySelectorAll(".level-select"))
        .map(sel => LEVEL_OPTIONS.find(o => o.field === sel.value))
        .filter(Boolean);
      if (!levels.length) {
        Swal.showValidationMessage("Please select at least one level.");
        return false;
      }
      return levels;
    }
  }).then(result => {
    if (result.isConfirmed) {
      createFieldsUI(name, result.value);
    }
  });
}

// Add Level Dropdown
function addLevelRow(){
  const div=document.createElement("div");
  div.className="level-row";
  div.innerHTML=`<select class='level-select'>
      <option value="">-- Select Level --</option>
      ${LEVEL_OPTIONS.map(l => `<option value='${l.field}'>${l.label}</option>`).join("")}
    </select>`;
  window.levelContainer.appendChild(div);
}

// Step 3: Choose Fields
async function createFieldsUI(name, levels){
  await Swal.fire({
    title:"Add Fields",
    html:`<div id="fields-area">
            <button class='add-btn' onclick='addNormalField()'>‚ûï Add Field</button>
            <div id="field-list"></div>
          </div>`,
    showCancelButton:true,
    confirmButtonText:"‚úÖ Save Template",
    didOpen:() => { window.fieldList=document.getElementById("field-list"); },
    preConfirm:() => {
      const fields = Array.from(document.querySelectorAll(".field-select"))
        .map(sel => FIELD_OPTIONS.find(o => o.field === sel.value))
        .filter(Boolean);
      if (!fields.length) {
        Swal.showValidationMessage("Please add at least one field.");
        return false;
      }
      return { name, levels, fields };
    }
  }).then(result=>{
    if(result.value){
      saveTemplate(result.value);
    }
  });
}

// Add Field Row
function addNormalField(){
  const div=document.createElement("div");
  div.className="field-item";
  div.innerHTML=`
    <select class="field-select">
      <option value="">-- Select Field --</option>
      ${FIELD_OPTIONS.map(f=>`<option value='${f.field}'>${f.label}</option>`).join("")}
    </select>
  `;
  fieldList.appendChild(div);
}

// Save Template
async function saveTemplate(template){
  try {
    const response = await fetch('/save_template', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(template)
    });
    if (response.ok) {
      Swal.fire("‚úÖ Template Saved!", "Template stored on server.", "success");
    } else {
      Swal.fire("‚ùå Error", "Could not save template file.", "error");
    }
  } catch (err) {
    console.error(err);
    Swal.fire("‚ùå Error", "Failed to connect to backend.", "error");
  }
}
</script>
</body>
</html>
