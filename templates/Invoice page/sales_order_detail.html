<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales Order Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='color-template.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        body {
            background: var(--primary-bg);
            font-size: 0.95rem;
            min-height: 100vh;
            color: var(--primary-text);
        }
        .sales-order-header-card {
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.08);
            padding: 1.5rem 2rem 1.2rem 2rem;
            margin-bottom: 2rem;
        }
        .sales-order-header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--logo-color);
            margin-bottom: 0.4rem;
        }
        .sales-order-header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-top: 1.2rem;
        }
        .sales-order-header-grid h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--secondary-text);
            margin-bottom: 0.2rem;
        }
        .sales-order-header-grid p {
            font-size: 0.95rem;
            color: var(--primary-text);
        }
        .sales-order-table-card {
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.08);
            padding: 1.5rem 2rem 1.2rem 2rem;
            margin-bottom: 2rem;
        }
        .sales-order-table-card h2 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-text);
            margin-bottom: 0.8rem;
        }
        .sales-order-lines-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--container-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        .sales-order-lines-table th {
            background: var(--table-header-bg);
            color: var(--table-header-text);
            font-weight: 700;
            border: none;
            padding: 0.6em 0.8em;
            text-align: left;
            white-space: nowrap;
        }
        .sales-order-lines-table td {
            border: none;
            padding: 0.6em 0.8em;
            color: var(--primary-text);
            background: var(--table-row-uneven);
            vertical-align: middle;
        }
        .sales-order-lines-table tbody tr:nth-child(even) td {
            background: var(--table-row-even);
        }
        .sales-order-lines-table tr:not(:last-child) td {
            border-bottom: 1px solid var(--table-border);
        }
        .sales-order-lines-table tfoot .totals-row td {
            background: var(--table-totals-row-bg);
            color: var(--table-totals-row-text);
            font-weight: 700;
        }
        .loading { text-align: center; font-size: 1.2em; color: var(--secondary-text); }
        .error { color: #dc2626; text-align: center; }
        
        /* Status badge styling */
        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.875rem;
            border: 1px solid;
        }
        .status-unprocessed {
            background: var(--muted-bg);
            color: var(--logo-color);
            border-color: var(--input-border);
        }
        .status-processed {
            background: #d1fae5;
            color: #059669;
            border-color: #6ee7b7;
        }
        .status-cancelled {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fecaca;
        }
        
        /* Link styling */
        .detail-link {
            color: var(--button-bg);
            text-decoration: none;
        }
        .detail-link:hover {
            text-decoration: underline;
        }
        
        /* Totals table styling */
        .totals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
        }
        .totals-table td {
            padding: 0.25rem 0;
            vertical-align: top;
        }
        .totals-table .border-top {
            border-top: 1px solid var(--table-border);
            padding-top: 0.5rem;
        }
        .totals-table .border-top-thick {
            border-top: 2px solid var(--primary-text);
            padding-top: 0.5rem;
        }
        .totals-table .nett-amount {
            font-size: 1.4em;
            font-weight: 700;
            color: #059669;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.5px;
        }
        /* Filter Buttons */
        .action-btn {
            text-align: center;
            margin: 15px 0;
            padding: 10px 0;
        }

        .action-btn {
            background-color: var(--muted-bg);
            color: var(--primary-text);
            /* border: 1px solid var(--input-border); */
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .action-btn :hover {
            background-color: var(--table-row-hover);
            border-color: var(--input-focus);
        }

        .action-btn .active {
            background-color: var(--button-bg) !important;
            color: var(--button-text);
            border-color: var(--button-bg);
        }
    </style>
</head>
<body>
{% include 'taskbar.html' %}
<div class="main-content py-8 with-fixed-taskbar">
    <div class="container-wide mx-auto px-4" style="max-width: 1200px;">
        <div id="loading" class="loading">Loading sales order...</div>
        <div id="sales-order-content" style="display:none;">
            <!-- Sales Order Header Card -->
            <div class="sales-order-header-card mb-6" style="position: relative;">
                <div style="position: absolute; top: 1.5rem; right: 2rem;">
                    <span id="sales-order-status-badge" class="status-badge"></span>
                    <button id="open-correct-modal" class="custom-btn" style="margin-left: 1rem;"><i class="fa fa-wrench"></i> Correct Invoice</button>
                </div>
                <div class="sales-order-header-title" id="sales-order-title"></div>
                <div class="sales-order-header-grid" id="sales-order-header-details"></div>
            </div>
            <!-- Line Items Table Card -->
            <div class="sales-order-table-card">
                <h2>Line Items</h2>
                <div id="sales-order-lines"></div>
                <div id="sales-order-header-totals" class="mt-4"></div>
            </div>
        </div>
        <div id="error-message" class="error" style="display:none;"></div>
    </div>
</div>
<script>
function getSalesOrderIdFromUrl() {
    const parts = window.location.pathname.split('/');
    return parts[parts.length - 1];
}

function renderHeader(header) {
    return `
        <div>
            <h2>Sales Order Date</h2>
            <p>${header.invoicedate || ''}</p>
        </div>
        <div>
            <h2>Delivery Note No</h2>
            <p><a href="/delivery-note/${header.invoicedelnoteno || ''}" class="detail-link">${header.invoicedelnoteno || ''}</a></p>
        </div>
        <div>
            <h2>Agent</h2>
            <p>${header.agentname}</p>
        </div>
        <div>
            <h2>Tax Rate</h2>
            <p>${header.invoicetaxrate || ''}%</p>
        </div>
        <div>
            <h2>Evo Sales Order No</h2>
            <p>${header.invoiceevosonumber || ''}</p>
        </div>
    `;
}

function formatCurrency(val) {
    return 'R ' + ((parseFloat(val) || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}));
}

function renderLines(lines) {
    const filtered = lines.filter(line => {
        const desc = (line.productdescription || '').toLowerCase().trim();
        return !(
            desc === 'commission market' ||
            desc === 'commission agent' ||
            desc === 'commission other'
        );
    });
    filtered.sort((a, b) => {
        const descA = (a.productdescription || '').toLowerCase();
        const descB = (b.productdescription || '').toLowerCase();
        if (descA < descB) return -1;
        if (descA > descB) return 1;
        return 0;
    });
    if (!filtered.length) return '<div>No line items found.</div>';
    let totalQty = 0;
    let totalAmount = 0;
    let rows = filtered.map(line => {
        totalQty += Number(line.salesqty) || 0;
        totalAmount += Number(line.salesamnt) || 0;
        return `
        <tr>
            <td>${line.salesdate || ''}</td>
            <td>${line.productdescription || ''}</td>
            <td>${line.salesqty || ''}</td>
            <td>${formatCurrency(line.discountamnt)}</td>
            <td>${formatCurrency(line.grosssalesamnt)}</td>
            <td>${formatCurrency(line.salesamnt)}</td>
        </tr>
        `;
    }).join('');
    let totalsRow = `
        <tr class="totals-row">
            <td colspan="2" class="text-right">Totals:</td>
            <td>${totalQty}</td>
            <td></td>
            <td></td>
            <td>${formatCurrency(totalAmount)}</td>
        </tr>
    `;
    return `
        <div class="overflow-auto">
        <table class="sales-order-lines-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Product</th>
                    <th>Qty</th>
                    <th>Discount</th>
                    <th>Gross Amount</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>${totalsRow}</tfoot>
        </table>
        </div>
    `;
}

function renderStatusBadge(status) {
    let statusClass = 'status-unprocessed';
    let text = 'Unprocessed';
    if (status) {
        const s = status.toLowerCase();
        if (s === 'processed') {
            statusClass = 'status-processed';
            text = 'Processed';
        } else if (s === 'cancelled') {
            statusClass = 'status-cancelled';
            text = 'Cancelled';
        }
    }
    return `<span class="status-badge ${statusClass}">${text}</span>`;
}

function renderHeaderTotals(header, totalAmount) {
    const totalDeducted = parseFloat(header.invoicetotaldeducted) || 0;
    const marketComm = parseFloat(header.invoicemarketcommincl) || 0;
    const agentComm = parseFloat(header.invoiceagentcommincl) || 0;
    const otherCosts = parseFloat(header.invoiceothercostsincl) || 0;
    const gross = parseFloat(header.invoicegross) || totalAmount || 0;
    const nett = parseFloat(header.invoicenett) || (gross - totalDeducted - marketComm - agentComm - otherCosts);
    function fmt(val) {
        return formatCurrency(val);
    }
    return `
    <div class="sales-order-table-card" style="margin-top:2em;">
      <table class="totals-table">
        <tr>
          <td style="width: 50%; vertical-align: top; padding-right: 2em;">
            <strong>Deductions Breakdown</strong><br><br>
            <table class="totals-table">
              <tr><td>Market Commission:</td><td style="text-align:right;">${fmt(marketComm)}</td></tr>
              <tr><td>Agent Commission:</td><td style="text-align:right;">${fmt(agentComm)}</td></tr>
              <tr><td>Other Costs:</td><td style="text-align:right;">${fmt(otherCosts)}</td></tr>
              <tr class="border-top">
                <td><strong>Total Deducted:</strong></td>
                <td style="text-align:right;"><strong>${fmt(totalDeducted)}</strong></td>
              </tr>
            </table>
          </td>
          <td style="width: 50%; vertical-align: top; padding-left: 2em;">
            <table class="totals-table">
              <tr><td style="padding-bottom: 0.5em;">&nbsp;</td></tr>
              <tr><td style="font-weight: bold;">Gross Amount:</td><td style="text-align:right;">${fmt(gross)}</td></tr>
              <tr><td style="font-weight: bold;">Less Deductions:</td><td style="text-align:right;">${fmt(totalDeducted)}</td></tr>
                               <tr class="border-top-thick">
                     <td style="font-weight: bold; font-size: 1.2em;">Nett Sales Order Amount:</td>
                     <td style="text-align:right;" class="nett-amount">${fmt(nett)}</td>
                 </tr>
            </table>
          </td>
        </tr>
      </table>
    </div>
    `;
}

async function loadSalesOrder() {
    const salesOrderId = getSalesOrderIdFromUrl();
    try {
        const response = await fetch(`/api/sales-order/${salesOrderId}`);
        if (!response.ok) throw new Error('Sales order not found');
        const data = await response.json();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('sales-order-content').style.display = '';
        document.getElementById('sales-order-title').textContent = `Sales Order #${data.sales_order_header.invoiceno || data.sales_order_header.InvoiceNo}`;
        document.getElementById('sales-order-header-details').innerHTML = renderHeader(data.sales_order_header);
        // Set status badge
        const status = data.sales_order_header.status || 'Unprocessed';
        document.getElementById('sales-order-status-badge').outerHTML = renderStatusBadge(status);
        document.getElementById('sales-order-lines').innerHTML = renderLines(data.sales_order_lines);
        // Calculate total amount for nett
        const filtered = data.sales_order_lines.filter(line => {
            const desc = (line.productdescription || '').toLowerCase().trim();
            return !(
                desc === 'commission market' ||
                desc === 'commission agent' ||
                desc === 'commission other'
            );
        });
        let totalAmount = 0;
        filtered.forEach(line => {
            totalAmount += Number(line.grosssalesamnt) || 0;
        });
        document.getElementById('sales-order-header-totals').innerHTML = renderHeaderTotals(data.sales_order_header, totalAmount);
    } catch (err) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-message').style.display = '';
        document.getElementById('error-message').textContent = err.message || 'Failed to load sales order.';
    }
}

window.addEventListener('DOMContentLoaded', loadSalesOrder);
</script>
<!-- Correction Modal -->
<div id="correct-modal" class="fixed inset-0 bg-black bg-opacity-40 hidden" style="z-index: 1000;">
    <div class="bg-white rounded-lg shadow-lg mx-auto my-12 p-6" style="max-width: 900px;">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold" style="color: var(--logo-color);">Correct Invoice</h2>
            <button id="close-correct-modal" class="text-gray-600 hover:text-gray-900"><i class="fa fa-times"></i></button>
        </div>
        <div id="correct-steps">
            <div class="mb-4 p-3 rounded" style="background: var(--muted-bg); border: 1px solid var(--table-border);">
                <div class="grid md:grid-cols-3 gap-3 text-sm">
                    <div><span class="font-semibold">Delivery Note:</span> <span id="cm-delnote"></span></div>
                    <div><span class="font-semibold">Invoice:</span> <span id="cm-invoice"></span></div>
                    <div><span class="font-semibold">Evo SO:</span> <span id="cm-evoso"></span></div>
                </div>
            </div>
            <!-- Step 1: Choose correction type -->
            <div id="step-type" class="mb-6">
                <p class="mb-2 font-semibold">Choose what you want to correct</p>
                <div class="action-btn-group">
                    <button id="choose-agent" class="action-btn">Edit Agent</button>
                    <button id="choose-prod" class="action-btn">Edit Production Unit</button>
                </div>
            </div>

            <!-- Agent correction -->
            <div id="step-agent" class="hidden">
                <div class="grid md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block mb-1 font-semibold">Current Agent</label>
                        <input id="cm-agent-current" class="w-full border rounded px-3 py-2 bg-gray-100" readonly />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block mb-1 font-semibold">New Agent</label>
                        <select id="cm-agent-select" class="w-full border rounded px-3 py-2"></select>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold mb-2">Invoices for delivery note</h3>
                    <table class="fs-table w-full">
                        <thead><tr><th>Invoice No</th><th>Date</th><th>Nett</th><th>Status</th></tr></thead>
                        <tbody id="cm-agent-invoices"></tbody>
                    </table>
                    <div class="mt-4 flex justify-end gap-2">
                        <button id="cm-agent-submit" class="btn-primary"><i class="fa fa-check"></i> Submit</button>
                    </div>
                </div>
            </div>

            <!-- Production unit correction -->
            <div id="step-prod" class="hidden">
                <div class="grid md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label class="block mb-1 font-semibold">Old Production Unit</label>
                        <select id="cm-old-prod" class="w-full border rounded px-3 py-2"></select>
                    </div>
                    <div>
                        <label class="block mb-1 font-semibold">New Production Unit</label>
                        <select id="cm-new-prod" class="w-full border rounded px-3 py-2"></select>
                    </div>
                    <div>
                        <button id="cm-prod-submit" class="btn-primary w-full">Submit</button>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-semibold mb-2">All Delivery Note Lines</h3>
                    <table class="fs-table w-full mb-4">
                        <thead><tr><th>Line</th><th>Product</th><th>Prod Unit</th><th>Status</th></tr></thead>
                        <tbody id="cm-prod-lines"></tbody>
                    </table>
                    <h3 class="font-semibold mb-2">Affected Invoices</h3>
                    <table class="fs-table w-full">
                        <thead><tr><th>Invoice No</th><th>Date</th><th>Nett</th><th>Status</th><th>Change</th></tr></thead>
                        <tbody id="cm-prod-invoices"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
</div>
<script src="{{ url_for('static', filename='Invoice/correct-modal.js') }}"></script>
</body>
</html> 